<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สมัครสมาชิกใหม่</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            /* ใช้ Gradient Background เหมือนหน้า Login */
            background: linear-gradient(-45deg, #e0fdf4, #d1fae5, #a7f3d0, #6ee7b7);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem 0;
            /* เพิ่ม padding บนล่างเผื่อฟอร์มยาว */
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Style Input ให้มี Icon ด้านใน (เหมือนหน้า Login) */
        .input-with-icon {
            position: relative;
            margin-bottom: 1.25rem;
            /* เพิ่มระยะห่างระหว่าง input */
        }

        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            transition: color 0.3s ease;
            z-index: 10;
            /* ให้ไอคอนอยู่หน้า input */
        }

        .input-with-icon input {
            padding-left: 36px;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
            padding-top: 0.75rem;
            /* py-3 */
            padding-bottom: 0.75rem;
            color: #374151;
            /* สีข้อความใน input */
            background-color: #fff;
            /* พื้นหลัง input */
        }

        .input-with-icon input::placeholder {
            color: #9ca3af;
            /* สี placeholder */
        }

        .input-with-icon input:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
            outline: none;
        }

        .input-with-icon input:focus+i {
            color: #10b981;
        }

        /* Style สำหรับข้อความ Error ใต้ Input */
        .error-text {
            font-size: 0.8rem;
            color: #ef4444;
            /* red-500 */
            margin-top: -0.75rem;
            /* ดึงขึ้นมาเล็กน้อย */
            margin-bottom: 0.75rem;
            padding-left: 0.25rem;
            height: 1rem;
            /* จองพื้นที่ กัน layout กระโดด */
            display: block;
            /* ทำให้ height มีผล */
        }

        /* Style ปุ่ม */
        .submit-button {
            width: 100%;
            background-image: linear-gradient(to right, #10b981, #059669);
            /* เปลี่ยนสี Gradient เล็กน้อย */
            color: white;
            padding: 0.85rem 1rem;
            /* ปรับขนาดปุ่ม */
            border-radius: 0.5rem;
            font-weight: 600;
            /* semibold */
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
            cursor: pointer;
        }

        .submit-button:hover {
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .submit-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Shake animation (เหมือนหน้า Login) */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>

<body>
    <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-lg m-4">
        <div class="text-center mb-8">
            <i class="fas fa-user-plus text-5xl text-green-600 mb-4"></i>
            <h1 class="text-3xl font-bold text-gray-800">สร้างบัญชีใหม่</h1>
            <p class="text-gray-500 mt-2">กรอกข้อมูลเพื่อสมัครสมาชิก</p>
        </div>

        <form id="register-form" novalidate>
            <div class="input-with-icon">
                <input type="text" id="username" name="username" required class=""
                    placeholder="ชื่อผู้ใช้ (ภาษาอังกฤษ/ตัวเลขเท่านั้น)">
                <i class="fas fa-user"></i>
                <span class="error-text" id="username-error"></span>
            </div>

            <div class="input-with-icon">
                <input type="email" id="email" name="email" required class="" placeholder="อีเมล">
                <i class="fas fa-envelope"></i>
                <span class="error-text" id="email-error"></span>
            </div>

            <div class="input-with-icon">
                <input type="password" id="password" name="password" required minlength="6" class=""
                    placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)">
                <i class="fas fa-lock"></i>
                <span class="error-text" id="password-error"></span>
            </div>

            <div class="input-with-icon">
                <input type="password" id="confirm-password" name="confirm-password" required class=""
                    placeholder="ยืนยันรหัสผ่าน">
                <i class="fas fa-check-circle"></i> <span class="error-text" id="confirm-password-error"></span>
            </div>

            <button type="submit" id="submit-button" class="submit-button mt-4">
                <i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก
            </button>

            <p id="form-message" class="text-sm mt-4 text-center h-5"></p>

        </form>

        <p class="text-center text-sm text-gray-600 mt-6">
            มีบัญชีอยู่แล้ว?
            <a href="login.html" class="text-green-600 hover:text-green-700 hover:underline font-medium">
                เข้าสู่ระบบที่นี่
            </a>
        </p>
    </div>

    <script>
        // --- Get DOM Elements ---
        const registerForm = document.getElementById('register-form');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const submitButton = document.getElementById('submit-button');
        const formMessage = document.getElementById('form-message');
        const usernameError = document.getElementById('username-error');
        const emailError = document.getElementById('email-error');
        const passwordError = document.getElementById('password-error');
        const confirmPasswordError = document.getElementById('confirm-password-error');

        // --- Input Validation Functions ---
        function validateUsername(username) {
            // อนุญาตเฉพาะ a-z, A-Z, 0-9 และ underscore, ความยาว 3-20 ตัวอักษร
            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            if (!username) {
                return "กรุณากรอกชื่อผู้ใช้";
            } else if (!usernameRegex.test(username)) {
                return "ชื่อผู้ใช้ต้องเป็นภาษาอังกฤษ/ตัวเลข/ขีดล่าง (_) 3-20 ตัวอักษร";
            }
            return ""; // No error
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                return "กรุณากรอกอีเมล";
            } else if (!emailRegex.test(email)) {
                return "รูปแบบอีเมลไม่ถูกต้อง";
            }
            return "";
        }

        function validatePassword(password) {
            if (!password) {
                return "กรุณากรอกรหัสผ่าน";
            } else if (password.length < 6) {
                return "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
            }
            // อาจเพิ่มเงื่อนไขความซับซ้อนอื่นๆ ได้ เช่น ต้องมีตัวเลข ตัวพิมพ์ใหญ่/เล็ก
            return "";
        }

        function validateConfirmPassword(password, confirmPassword) {
            if (!confirmPassword) {
                return "กรุณายืนยันรหัสผ่าน";
            } else if (password !== confirmPassword) {
                return "รหัสผ่านและการยืนยันไม่ตรงกัน";
            }
            return "";
        }

        // --- Function to display errors ---
        function showError(inputElement, errorElement, message) {
            errorElement.textContent = message;
            if (message) {
                inputElement.classList.add('border-red-500'); // Add red border
                inputElement.classList.remove('border-green-500'); // Remove green border if any
            } else {
                inputElement.classList.remove('border-red-500');
                // Optional: Add green border on valid input after typing
                if (inputElement.value) { // Only add green if there's value
                    inputElement.classList.add('border-green-500');
                }
            }
        }

        // --- Real-time Validation on Input ---
        usernameInput.addEventListener('input', () => {
            const error = validateUsername(usernameInput.value.trim());
            showError(usernameInput, usernameError, error);
        });
        emailInput.addEventListener('input', () => {
            const error = validateEmail(emailInput.value.trim());
            showError(emailInput, emailError, error);
        });
        passwordInput.addEventListener('input', () => {
            const error = validatePassword(passwordInput.value);
            showError(passwordInput, passwordError, error);
            // Re-validate confirm password when password changes
            const confirmError = validateConfirmPassword(passwordInput.value, confirmPasswordInput.value);
            showError(confirmPasswordInput, confirmPasswordError, confirmError);
        });
        confirmPasswordInput.addEventListener('input', () => {
            const error = validateConfirmPassword(passwordInput.value, confirmPasswordInput.value);
            showError(confirmPasswordInput, confirmPasswordError, error);
        });

        // --- Form Submission Handler ---
        registerForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default HTML form submission
            formMessage.textContent = ''; // Clear previous form message
            formMessage.className = 'text-sm mt-4 text-center h-5'; // Reset class

            // --- Final Validation Check ---
            const username = usernameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            const usernameValidationError = validateUsername(username);
            const emailValidationError = validateEmail(email);
            const passwordValidationError = validatePassword(password);
            const confirmPasswordValidationError = validateConfirmPassword(password, confirmPassword);
            showError(usernameInput, usernameError, usernameValidationError);
            showError(emailInput, emailError, emailValidationError);
            showError(passwordInput, passwordError, passwordValidationError);
            showError(confirmPasswordInput, confirmPasswordError, confirmPasswordValidationError);

            // Check if any validation error exists
            if (usernameValidationError || emailValidationError || passwordValidationError || confirmPasswordValidationError) {
                formMessage.textContent = "กรุณากรอกข้อมูลให้ถูกต้อง";
                formMessage.classList.add('text-red-500');
                // Shake the form on error
                registerForm.closest('.bg-white').classList.add('animate-shake');
                setTimeout(() => registerForm.closest('.bg-white').classList.remove('animate-shake'), 500);
                return; // Stop submission
            }

            // --- !!! การลงทะเบียนผู้ใช้ (สำคัญมาก) !!! ---
            // ในแอปจริง ส่วนนี้ต้องส่งข้อมูล (username, email, password) ไปสร้างผู้ใช้ที่ Server
            // ห้าม!!! บันทึกรหัสผ่านเป็น Plain Text ใน localStorage เด็ดขาด!
            // Server ควรจะ Hash รหัสผ่านก่อนบันทึกลงฐานข้อมูล และตรวจสอบว่า username/email ไม่ซ้ำ
            // โค้ดด้านล่างเป็นเพียงตัวอย่างจำลองการทำงานเท่านั้น

            console.log('Simulating registration for:', username, email);
            submitButton.disabled = true; // Disable button during processing
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังดำเนินการ...'; // Show loading state

            simulateServerRegistration(username, email, password)
                .then(userData => {
                    // --- Registration สำเร็จ ---
                    console.log('Registration successful:', userData);
                    formMessage.textContent = `สมัครสมาชิกสำเร็จ! ยินดีต้อนรับคุณ ${userData.username}. กำลังนำคุณไปหน้า Login...`;
                    formMessage.className = 'text-sm mt-4 text-center h-5 text-green-600'; // Green text for success

                    // Clear form (optional)
                    // registerForm.reset();
                    // Clear error styles
                    [usernameInput, emailInput, passwordInput, confirmPasswordInput].forEach(input => {
                        input.classList.remove('border-red-500', 'border-green-500');
                    });

                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = 'login.html'; // ไปหน้า Login
                    }, 2500); // Delay 2.5 วินาทีให้เห็นข้อความ Success

                })
                .catch(error => {
                    // --- Registration ไม่สำเร็จ ---
                    console.error('Registration failed:', error);
                    formMessage.textContent = error; // Show error from simulation
                    formMessage.className = 'text-sm mt-4 text-center h-5 text-red-500'; // Red text for error
                    // Shake the form on error
                    registerForm.closest('.bg-white').classList.add('animate-shake');
                    setTimeout(() => registerForm.closest('.bg-white').classList.remove('animate-shake'), 500);

                    // Check if error is about existing user and highlight relevant field
                    if (error.toLowerCase().includes('ชื่อผู้ใช้')) {
                        showError(usernameInput, usernameError, error);
                    } else if (error.toLowerCase().includes('อีเมล')) {
                        showError(emailInput, emailError, error);
                    }

                    submitButton.disabled = false; // Re-enable button
                    submitButton.innerHTML = '<i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก'; // Restore button text
                });
        });

        // --- ฟังก์ชันจำลองการลงทะเบียนที่ Server ---
        function simulateServerRegistration(username, email, password) {
            return new Promise((resolve, reject) => {
                setTimeout(() => { // จำลองดีเลย์ของ Network
                    // --- ตรรกะการตรวจสอบ (ที่ควรอยู่บน Server) ---

                    // 1. ตรวจสอบว่า Username หรือ Email ซ้ำหรือไม่ (จำลองโดยใช้ localStorage)
                    let existingUsers = JSON.parse(localStorage.getItem('simulatedUsers') || '{}');

                    if (existingUsers[username]) {
                        reject(`ชื่อผู้ใช้ "${username}" นี้มีอยู่ในระบบแล้ว`);
                        return;
                    }
                    // ตรวจสอบ Email ซ้ำ (แบบง่ายๆ)
                    for (const userKey in existingUsers) {
                        if (existingUsers[userKey].email === email) {
                            reject(`อีเมล "${email}" นี้มีอยู่ในระบบแล้ว`);
                            return;
                        }
                    }

                    // 2. ถ้าไม่ซ้ำ ให้บันทึกข้อมูลผู้ใช้ใหม่ (จำลอง)
                    // !!! สำคัญ: ในชีวิตจริง ต้อง Hash รหัสผ่านก่อนบันทึก !!!
                    const newUser = {
                        email: email,
                        // ไม่ควรเก็บ password แบบนี้ในชีวิตจริง!
                        // ควรเก็บแค่ password hash
                        // password: password, // <--- ไม่ควรทำแบบนี้
                        password_simulation: password, // ใช้ชื่อนี้เพื่อย้ำว่าเป็นการจำลอง
                        createdAt: new Date().toISOString(),
                        profileImage: null, // เริ่มต้นยังไม่มีรูป
                        lastLogin: null,
                        streak: 0
                    };
                    existingUsers[username] = newUser;
                    localStorage.setItem('simulatedUsers', JSON.stringify(existingUsers));

                    // สร้างข้อมูล user data แยก (เหมือนหน้า login) เพื่อให้ง่ายต่อการดึง profileImage/lastLogin
                    // แต่จริงๆ ควรดึงจากข้อมูลหลักตอน login
                    localStorage.setItem('userData_' + username, JSON.stringify({
                        profileImage: newUser.profileImage,
                        lastLogin: newUser.lastLogin,
                        streak: newUser.streak
                    }));


                    // 3. ส่งข้อมูลผู้ใช้ (บางส่วน) กลับไปเพื่อยืนยัน
                    const userDataForClient = {
                        username: username,
                        email: email,
                        // ไม่ส่ง password กลับไปเด็ดขาด
                    };
                    resolve(userDataForClient);

                }, 1000); // หน่วงเวลา 1 วินาที
            });
        }
    </script>
</body>

</html>